var data = {
  words: {
    "0": "China",
    "1": "Trump",
    "2": "outbreak",
    "3": "health",
    "4": "New York",
    "5": "spread",
    "6": "Wuhan",
    "7": "test",
    "8": "market",
    "9": "travel",
    "10": "world",
    "11": "stock",
    "12": "death",
    "13": "global",
    "14": "state",
    "15": "official",
    "16": "infection",
    "17": "fall/fell",
    "18": "points",
    "19": "patient",
    "20": "fears",
    "21": "American",
    "22": "economy",
    "23": "hospital",
    "24": "pandemic",
    "25": "symptoms",
    "26": "doctor",
    "27": "million",
    "28": "oil",
    "29": "SP 500",
    "30": "Korea",
    "31": "public",
    "32": "work",
    "33": "rose",
    "34": "cuts",
    "35": "question",
    "36": "passengers",
    "37": "quarantine",
    "38": "response",
    "39": "warned",
    "40": "flight",
    "41": "NASDAQ",
    "42": "ship",
    "43": "sick",
    "44": "city",
    "45": "south",
    "46": "workers",
    "47": "Italy",
    "48": "rate",
    "49": "SARS",
    "50": "medical",
    "51": "risk",
    "52": "cruise",
    "53": "mask",
    "54": "toll",
    "55": "treat",
    "56": "CDC",
    "57": "positive",
    "58": "airlines",
    "59": "index",
    "60": "number",
    "61": "billion",
    "62": "emergency",
    "63": "stay",
    "64": "Washington",
    "65": "Japan",
    "66": "senate",
    "67": "stimulus",
    "68": "countries",
    "69": "Europe",
    "70": "country",
    "71": "supply",
    "72": "face",
    "73": "help",
    "74": "national",
    "75": "crisis",
    "76": "crude",
    "77": "declares",
    "78": "disease",
    "79": "growth",
    "80": "investors",
    "81": "media",
    "82": "shares",
    "83": "social",
    "84": "price",
    "85": "democrats",
    "86": "federal",
    "87": "flu",
    "88": "outside",
    "89": "severe",
    "90": "vaccine",
    "91": "close",
    "92": "evacuees",
    "93": "illness",
    "94": "Iran",
    "95": "production",
    "96": "right",
    "97": "businesses",
    "98": "California",
    "99": "employee",
    "100": "panic",
    "101": "statement",
    "102": "transmission",
    "103": "bill",
    "104": "citizens",
    "105": "Dow",
    "106": "republicans",
    "107": "respiratory",
    "108": "Sanders",
    "109": "ventilators, ",
    "110": "administration",
    "111": "international",
    "112": "OPEC",
    "113": "press",
    "114": "protective",
    "115": "restrictions",
    "116": "sign",
    "117": "airport",
    "118": "order",
    "119": "Pelosi",
    "120": "calls",
    "121": "control",
    "122": "drug",
    "123": "Hong Kong",
    "124": "Princess",
    "125": "science",
    "126": "announce",
    "127": "democratic",
    "128": "department",
    "129": "Hydroxychloroquine",
    "130": "trial",
    "131": "experts",
    "132": "foreign",
    "133": "impeachment",
    "134": "wash",
    "135": "family",
    "136": "Twitter",
    "137": "wildlife",
    "138": "Biden",
  },

  Reuters: {
    "0": 153,
    "1": 33,
    "2": 69,
    "3": 65,
    "4": 64,
    "5": 50,
    "6": 41,
    "7": 29,
    "8": 82,
    "9": 32,
    "10": 38,
    "11": 68,
    "12": 33,
    "13": 63,
    "14": 6,
    "15": 12,
    "16": 15,
    "17": 60,
    "18": 52,
    "19": 11,
    "20": 34,
    "21": 8,
    "22": 30,
    "23": 5,
    "24": 12,
    "25": 6,
    "26": 3,
    "27": 27,
    "28": 40,
    "29": 39,
    "30": 14,
    "31": 5,
    "32": 13,
    "33": 36,
    "34": 28,
    "35": 2,
    "36": 9,
    "37": 4,
    "38": 3,
    "39": 13,
    "40": 11,
    "41": 32,
    "42": 5,
    "43": 2,
    "44": 13,
    "45": 14,
    "46": 7,
    "47": 20,
    "48": 18,
    "49": 9,
    "50": 10,
    "51": 8,
    "52": 4,
    "53": 6,
    "54": 14,
    "55": 1,
    "56": 5,
    "57": 6,
    "58": 13,
    "59": 26,
    "60": 7,
    "61": 17,
    "62": 8,
    "63": 2,
    "64": 8,
    "65": 9,
    "66": 5,
    "67": 17,
    "68": 12,
    "69": 14,
    "70": 0,
    "71": 12,
    "72": 5,
    "73": 7,
    "74": 4,
    "75": 6,
    "76": 19,
    "77": 8,
    "78": 8,
    "79": 13,
    "80": 17,
    "81": 2,
    "82": 18,
    "83": 1,
    "84": 13,
    "85": 1,
    "86": 6,
    "87": 0,
    "88": 9,
    "89": 4,
    "90": 7,
    "91": 9,
    "92": 8,
    "93": 0,
    "94": 5,
    "95": 12,
    "96": 0,
    "97": 3,
    "98": 2,
    "99": 9,
    "100": 5,
    "101": 5,
    "102": 4,
    "103": 4,
    "104": 6,
    "105": 11,
    "106": 5,
    "107": 3,
    "108": 2,
    "109": 3,
    "110": 2,
    "111": 6,
    "112": 13,
    "113": 0,
    "114": 0,
    "115": 1,
    "116": 2,
    "117": 4,
    "118": 1,
    "119": 2,
    "120": 2,
    "121": 2,
    "122": 3,
    "123": 4,
    "124": 1,
    "125": 3,
    "126": 0,
    "127": 2,
    "128": 0,
    "129": 0,
    "130": 1,
    "131": 3,
    "132": 2,
    "133": 0,
    "134": 0,
    "135": 0,
    "136": 2,
    "137": 0,
    "138": 3,
  },
  "Fox News": {
    "0": 114,
    "1": 125,
    "2": 67,
    "3": 62,
    "4": 20,
    "5": 26,
    "6": 35,
    "7": 33,
    "8": 6,
    "9": 36,
    "10": 28,
    "11": 5,
    "12": 22,
    "13": 5,
    "14": 27,
    "15": 39,
    "16": 33,
    "17": 0,
    "18": 0,
    "19": 21,
    "20": 4,
    "21": 22,
    "22": 7,
    "23": 20,
    "24": 14,
    "25": 6,
    "26": 20,
    "27": 9,
    "28": 0,
    "29": 0,
    "30": 13,
    "31": 17,
    "32": 10,
    "33": 0,
    "34": 3,
    "35": 4,
    "36": 18,
    "37": 18,
    "38": 17,
    "39": 6,
    "40": 20,
    "41": 0,
    "42": 17,
    "43": 3,
    "44": 9,
    "45": 8,
    "46": 13,
    "47": 4,
    "48": 0,
    "49": 9,
    "50": 14,
    "51": 8,
    "52": 18,
    "53": 6,
    "54": 8,
    "55": 6,
    "56": 14,
    "57": 14,
    "58": 9,
    "59": 0,
    "60": 10,
    "61": 5,
    "62": 12,
    "63": 10,
    "64": 6,
    "65": 12,
    "66": 17,
    "67": 6,
    "68": 6,
    "69": 1,
    "70": 13,
    "71": 4,
    "72": 6,
    "73": 5,
    "74": 9,
    "75": 7,
    "76": 0,
    "77": 7,
    "78": 6,
    "79": 1,
    "80": 1,
    "81": 12,
    "82": 1,
    "83": 7,
    "84": 4,
    "85": 15,
    "86": 6,
    "87": 6,
    "88": 3,
    "89": 4,
    "90": 7,
    "91": 2,
    "92": 7,
    "93": 10,
    "94": 9,
    "95": 1,
    "96": 6,
    "97": 10,
    "98": 8,
    "99": 5,
    "100": 5,
    "101": 6,
    "102": 6,
    "103": 8,
    "104": 2,
    "105": 1,
    "106": 7,
    "107": 8,
    "108": 8,
    "109": 3,
    "110": 7,
    "111": 6,
    "112": 0,
    "113": 10,
    "114": 5,
    "115": 7,
    "116": 4,
    "117": 5,
    "118": 7,
    "119": 10,
    "120": 8,
    "121": 5,
    "122": 6,
    "123": 7,
    "124": 8,
    "125": 2,
    "126": 7,
    "127": 6,
    "128": 9,
    "129": 8,
    "130": 5,
    "131": 3,
    "132": 5,
    "133": 6,
    "134": 2,
    "135": 4,
    "136": 5,
    "137": 2,
    "138": 6,
  },

  "NY Times": {
    "0": 86,
    "1": 52,
    "2": 25,
    "3": 31,
    "4": 51,
    "5": 33,
    "6": 33,
    "7": 42,
    "8": 11,
    "9": 26,
    "10": 22,
    "11": 9,
    "12": 26,
    "13": 8,
    "14": 37,
    "15": 16,
    "16": 18,
    "17": 2,
    "18": 3,
    "19": 18,
    "20": 7,
    "21": 13,
    "22": 6,
    "23": 18,
    "24": 17,
    "25": 31,
    "26": 19,
    "27": 6,
    "28": 1,
    "29": 2,
    "30": 11,
    "31": 15,
    "32": 14,
    "33": 0,
    "34": 3,
    "35": 28,
    "36": 6,
    "37": 11,
    "38": 13,
    "39": 14,
    "40": 1,
    "41": 0,
    "42": 10,
    "43": 27,
    "44": 9,
    "45": 9,
    "46": 11,
    "47": 6,
    "48": 12,
    "49": 12,
    "50": 5,
    "51": 13,
    "52": 6,
    "53": 16,
    "54": 6,
    "55": 21,
    "56": 8,
    "57": 7,
    "58": 4,
    "59": 0,
    "60": 9,
    "61": 3,
    "62": 5,
    "63": 13,
    "64": 11,
    "65": 3,
    "66": 2,
    "67": 1,
    "68": 5,
    "69": 8,
    "70": 9,
    "71": 6,
    "72": 10,
    "73": 8,
    "74": 7,
    "75": 6,
    "76": 0,
    "77": 4,
    "78": 5,
    "79": 5,
    "80": 1,
    "81": 5,
    "82": 0,
    "83": 11,
    "84": 1,
    "85": 1,
    "86": 5,
    "87": 11,
    "88": 5,
    "89": 9,
    "90": 3,
    "91": 5,
    "92": 1,
    "93": 6,
    "94": 2,
    "95": 3,
    "96": 10,
    "97": 2,
    "98": 5,
    "99": 1,
    "100": 5,
    "101": 4,
    "102": 5,
    "103": 2,
    "104": 6,
    "105": 2,
    "106": 2,
    "107": 3,
    "108": 4,
    "109": 8,
    "110": 4,
    "111": 1,
    "112": 0,
    "113": 3,
    "114": 8,
    "115": 5,
    "116": 7,
    "117": 3,
    "118": 4,
    "119": 0,
    "120": 1,
    "121": 4,
    "122": 2,
    "123": 0,
    "124": 2,
    "125": 15,
    "126": 2,
    "127": 1,
    "128": 0,
    "129": 1,
    "130": 3,
    "131": 2,
    "132": 1,
    "133": 2,
    "134": 19,
    "135": 20,
    "136": 1,
    "137": 2,
    "138": 1,
  },
};

var showData = function () {
  //document is also global, but a subset of windows. you can grab stuff from html file using document.
  //the value of select corresponds to the value chosen on the website. left corresponds left in html. this allows
  //assigning values. this differs from nyt. there it is generated every time you click on show.
  var left = document.getElementById("left").value;
  var right = document.getElementById("right").value;
  var html_to_insert =
    '<div class="g-labels"></div>    <svg class="g-nodes" width="1070" height="640"></svg>';

  // innerHTML is stuff inside select id (in html file)
  document.getElementById("g-chart").innerHTML = html_to_insert;

  var width = 1040,
    height = 640;

  var collisionPadding = 4,
    clipPadding = 4,
    minRadius = 16, // minimum collision radius
    maxRadius = 65; // currently-displayed topic

  var formatShortCount = d3.format(",.0f");

  var max = 0;
  for (var i in data.words) {
    var sum = data[left][i] + data[right][i];
    if (max < sum) max = sum;
  }

  var r = d3.scale.sqrt().domain([0, max]).range([0, maxRadius]);

  var force = d3.layout
    .force()
    .charge(0)
    .size([width, height - 80])
    .on("tick", tick);

  var node = d3.select(".g-nodes").selectAll(".g-node"),
    label = d3.select(".g-labels").selectAll(".g-label"),
    arrow = d3.select(".g-nodes").selectAll(".g-note-arrow");

  d3.select(".g-nodes")
    .append("rect")
    .attr("class", "g-overlay")
    .attr("width", width)
    .attr("height", height)
    .on("click", clear);

  update();

  window.update = update;

  // Update the known topics.
  function update() {
    data.display = [];

    for (var w in data.words) {
      var leftCount = data[left][w];
      var rightCount = data[right][w];
      var totalCount = leftCount + rightCount;

      var d = {};
      d.id = w;
      d.count = totalCount;
      d.left = leftCount;
      d.right = rightCount;
      d.name = data.words[w];
      d.r = r(totalCount);
      d.cr = Math.max(minRadius, d.r);
      d.k = fraction(leftCount, rightCount);
      if (isNaN(d.k)) d.k = 0.5;
      if (isNaN(d.x)) d.x = (1 - d.k) * width + Math.random();
      d.bias = 0.5 - Math.max(0.1, Math.min(0.9, d.k));
      data.display.push(d);
    }

    force.nodes(data.display).start();
    updateNodes();
    updateLabels();
  }

  // Update the displayed nodes.
  function updateNodes() {
    node = node.data(data.display, function (d) {
      return d.name;
    });

    node.exit().remove();
    var nodeEnter = node
      .enter()
      .append("a")
      .attr("class", "g-node")
      .attr("xlink:href", function (d) {
        return "#" + encodeURIComponent(d.name);
      })
      .call(force.drag);

    var leftEnter = nodeEnter.append("g").attr("class", "g-left");

    leftEnter
      .append("clipPath")
      .attr("id", function (d) {
        return "g-clip-left-" + d.id;
      })
      .append("rect");

    leftEnter.append("circle");

    var rightEnter = nodeEnter.append("g").attr("class", "g-right");

    rightEnter
      .append("clipPath")
      .attr("id", function (d) {
        return "g-clip-right-" + d.id;
      })
      .append("rect");

    rightEnter.append("circle");

    nodeEnter.append("line").attr("class", "g-split");

    node
      .selectAll("rect")
      .attr("y", function (d) {
        return -d.r - clipPadding;
      })
      .attr("height", function (d) {
        return 2 * d.r + 2 * clipPadding;
      });

    node
      .select(".g-left rect")
      .style("display", function (d) {
        return d.k > 0 ? null : "none";
      })
      .attr("x", function (d) {
        return -d.r - clipPadding;
      })
      .attr("width", function (d) {
        return 2 * d.r * d.k + clipPadding;
      });

    node
      .select(".g-right rect")
      .style("display", function (d) {
        return d.k < 1 ? null : "none";
      })
      .attr("x", function (d) {
        return -d.r + 2 * d.r * d.k;
      })
      .attr("width", function (d) {
        return 2 * d.r;
      });

    node.select(".g-left circle").attr("clip-path", function (d) {
      return d.k < 1 ? "url(#g-clip-left-" + d.id + ")" : null;
    });

    node.select(".g-right circle").attr("clip-path", function (d) {
      return d.k > 0 ? "url(#g-clip-right-" + d.id + ")" : null;
    });

    node
      .select(".g-split")
      .attr("x1", function (d) {
        return -d.r + 2 * d.r * d.k;
      })
      .attr("y1", function (d) {
        return -Math.sqrt(d.r * d.r - Math.pow(-d.r + 2 * d.r * d.k, 2));
      })
      .attr("x2", function (d) {
        return -d.r + 2 * d.r * d.k;
      })
      .attr("y2", function (d) {
        return Math.sqrt(d.r * d.r - Math.pow(-d.r + 2 * d.r * d.k, 2));
      });

    node.selectAll("circle").attr("r", function (d) {
      return r(d.count);
    });
  }

  // Update the displayed node labels.
  function updateLabels() {
    label = label.data(data.display, function (d) {
      return d.name;
    });

    label.exit().remove();

    var labelEnter = label
      .enter()
      .append("a")
      .attr("class", "g-label")
      .attr("href", function (d) {
        return "#" + encodeURIComponent(d.name);
      })
      .call(force.drag);

    labelEnter
      .append("div")
      .attr("class", "g-name")
      .text(function (d) {
        return d.name;
      });

    labelEnter.append("div").attr("class", "g-value");

    label
      .style("font-size", function (d) {
        return Math.max(8, d.r / 2) + "px";
      })
      .style("width", function (d) {
        return d.r * 2.5 + "px";
      });

    // Create a temporary span to compute the true text width.
    label
      .append("span")
      .text(function (d) {
        return d.name;
      })
      .each(function (d) {
        d.dx = Math.max(d.r * 2.5, this.getBoundingClientRect().width);
      })
      .remove();

    label
      .style("width", function (d) {
        return d.dx + "px";
      })
      .select(".g-value")
      .text(function (d) {
        return formatShortCount(d.left) + " - " + formatShortCount(d.right);
      });

    // Compute the height of labels when wrapped.
    label.each(function (d) {
      d.dy = this.getBoundingClientRect().height;
    });
  }

  function tick(e) {
    node
      .each(bias(e.alpha * 105))
      .each(collide(0.1))
      .attr("transform", function (d) {
        return "translate(" + d.x + "," + d.y + ")";
      });

    label
      .style("left", function (d) {
        return d.x - d.dx / 2 + "px";
      })
      .style("top", function (d) {
        return d.y - d.dy / 2 + "px";
      });

    arrow.style("stroke-opacity", function (d) {
      var dx = d.x - d.cx,
        dy = d.y - d.cy;
      return dx * dx + dy * dy < d.r * d.r ? 1 : 0;
    });
  }

  // A left-right bias causing topics to orient by party preference.
  function bias(alpha) {
    return function (d) {
      d.x += d.bias * alpha;
    };
  }

  // Resolve collisions between nodes.
  function collide(alpha) {
    var q = d3.geom.quadtree(data.display);
    return function (d) {
      var r = d.cr + maxRadius + collisionPadding,
        nx1 = d.x - r,
        nx2 = d.x + r,
        ny1 = d.y - r,
        ny2 = d.y + r;
      q.visit(function (quad, x1, y1, x2, y2) {
        if (
          quad.point &&
          quad.point !== d &&
          d.other !== quad.point &&
          d !== quad.point.other
        ) {
          var x = d.x - quad.point.x,
            y = d.y - quad.point.y,
            l = Math.sqrt(x * x + y * y),
            r = d.cr + quad.point.r + collisionPadding;
          if (l < r) {
            l = ((l - r) / l) * alpha;
            d.x -= x *= l;
            d.y -= y *= l;
            quad.point.x += x;
            quad.point.y += y;
          }
        }
        return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
      });
    };
  }

  // Given two quantities a and b, returns the fraction to split the circle a + b.
  function fraction(a, b) {
    var k = a / (a + b);
    if (k > 0 && k < 1) {
      var t0,
        t1 = Math.pow(12 * k * Math.PI, 1 / 3);
      for (var i = 0; i < 10; ++i) {
        // Solve for theta numerically.
        t0 = t1;
        t1 =
          (Math.sin(t0) - t0 * Math.cos(t0) + 2 * k * Math.PI) /
          (1 - Math.cos(t0));
      }
      k = (1 - Math.cos(t1 / 2)) / 2;
    }
    return k;
  }

  // Clear the active topic when clicking on the chart background.
  function clear() {
    location.replace("#!");
  }
};

showData();
